<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Help - Eclipse Platform</title>
    <style>
        #navigation {
            position: fixed;
            top: 0;
            left: 0;
            width: 20%;
            height: 98vh;
            overflow-y: scroll;
        }

        #linkNav {
            position: fixed;
            bottom: 0;
            left: 15%;
            width: 5%;
            padding-top: 0.5em;
            background: rgba(192, 192, 192, 0.5);

        }

        #linkNav button {
            display: block;
            margin: 0.5em auto;
        }

        iframe {
            width: 79%;
            float: right;
            height: 98vh;
        }

        /* ç‹¬ç«‹ä¸€è¡Œ */
        #tocNav a {
            display: block;
            text-decoration: none;
            color: #000;
        }

        #tocNav details {
            padding-left: 1.5em
        }

        #tocNav details>summary {
            margin-left: -1.5em
        }

        /*è¡Œå†…å…ƒç´  å¦åˆ™ä¼šå¤šå‡ºä¸€è¡Œ*/
        #tocNav summary>a {
            display: inline;
        }

        #tocNav>details>summary::before {
            content: url("images/toc_open.gif");

        }

        #tocNav details>a::before {
            content: url("images/topic.gif");
        }

        #tocNav>details details>summary>a::before {
            content: url("images/container_obj.gif");
        }

        #tocNav>details details>summary>a.ad::before {
            content: url("images/container_topic.gif");
        }
    </style>
    <script>

        const parser = new DOMParser();
        let context;//å¸®åŠ©æ–‡æ¡£æ‰€åœ¨è·¯å¾„ ä¸Šä¸‹æ–‡
        let hrefContext;//å¸¦httpçš„å…¨è·¯å¾„
        let windowsUrl;//å½“å‰è·¯å¾„url

        let navA = null;//å¯¼èˆªé“¾æ¥åˆ—è¡¨ ä½¿ç”¨è·³è½¬ä¸Šä¸€é¡µä¸‹ä¸€é¡µ
        let currentA = null;//å½“å‰è¶…é“¾æ¥
        let currentIndex = null;//å½“å‰åœ°å€è¡¨

        let version = '';//ç‰ˆæœ¬ æœ€æ–°ä¸º 2019-06
        let tocfragmentT = '';//å¦‚æœä¸­æ–‡å¯¹åº”è‹±æ–‡åœ°å€å¦‚æœè‹±æ–‡å¯¹åº”ä¸­æ–‡åœ°å€
        let tocfragmentTFlag = false;//æ˜¯å¦å­˜åœ¨ 404
        let tocfragmentTURL = "";//å¯¹åº”åœ°å€

        //ç›®å½•æ˜¾ç¤ºæ§åˆ¶
        function displayToc() {
            if (navigation.style.display == '') {
                navigation.style.display = 'none';//éšè—
                document.getElementById('_iframe').style.width = "100%";
                linkNav.style.left = '0%';//è¿˜åŸ 
            } else {
                navigation.style.display = '';//è¿˜åŸ
                document.getElementById('_iframe').style.width = "79%";

                linkNav.style.left = '15%';//è¿˜åŸ  
            }
        }


        //æ›´æ–°å¯¼èˆªèœå•æ æ‰€æœ‰è¶…é“¾æ¥
        function updateNavHrefs() {
            navA = [...document.querySelectorAll('#tocNav a')].filter(a => a.getAttribute('href'));//.forEach(a => a.getAttribute('href') && navA.push(a.getAttribute('href')));
            console.log("å½“å‰å¯¼èˆªé“¾æ¥æ•°:" + navA.length);
        }

        //ä¸è€ƒè™‘ navHrefsä¸ºç©º
        function goPage(offset) {
            if (window.location.hash && navA.length > 0) {

                let cHref = window.location.hash.substr(1);//å½“å‰é“¾æ¥
                let cIndex = navA.findIndex(a => a.getAttribute('href')
                    && a.getAttribute('href').endsWith(cHref));//hrefæœ‰å€¼ å¹¶ä¸”æœ‰å½“å‰åœ°å€çš„åç¼€ å¹¶ä¸” å½“å‰ aä¸ºç©º æˆ–è€… å½“å‰ä¸æ˜¯æ­¤

                console.log(`cIndex = ${cIndex} + ${offset}`);
                cIndex += offset;
                //å¦‚æœä¿ç•™äº†å‰ä¸€æ¬¡åæ ‡ å¹¶ä¸”ä¸¤æ¬¡åæ ‡çš„ hrefå€¼ä¸€è‡´ åˆ™ ä»¥å‰ä¸€æ¬¡åæ ‡å€¼  ä¸ºå‡† 
                if (currentIndex && navA[currentIndex].getAttribute('href') == navA[cIndex].getAttribute('href')) {
                    cIndex = currentIndex + offset;
                }
                if (cIndex < 0) {
                    cIndex = 0;//æœ€å°æ˜¯å¤´
                    console.log("è¶…è¿‡æœ€å° è®¾ç½®ä¸º0");
                } else if (cIndex >= navA.length) {
                    cIndex = navA.length - 1;//æœ€å¤§æ˜¯å°¾
                    console.log("è¶…è¿‡æœ€æœ«è®¾ç½®ä¸ºæœ€æœ«");
                }
                currentIndex = cIndex;
                currentA = navA[cIndex];

                if (currentA && currentA.getAttribute('href')) {
                    //è·³è½¬ç›®æ ‡é¡µé¢
                    document.getElementById('_iframe').src = currentA.getAttribute('href');
                    iframeLoad();//æœ‰æ—¶å€™åªæ˜¯hashå˜åŒ–ä¸ä¼šè§¦å‘
                    currentA.style.background = 'lightskyblue'; //é¢œè‰²æ˜¾è‘—ä¸€ä¸‹  
                    bookmark.style.top = currentA.getBoundingClientRect().top + "px";
                }


            }
        }

        const load = async () => {

            //è¯»å–å½“å‰url
            windowsUrl = new URL(window.location.href);
            //è¯»å–Rsså‚æ•°
            let tocfragment = windowsUrl.searchParams.get("tocfragment");

            //æ²¡æœ‰ä¼ é€’å€¼åˆ™åŠ è½½é»˜è®¤å€¼
            tocfragment = tocfragment || '../local-doc-help.eclipse.org-2019-06/tocfragment.xml';

            console.log("tocfragment:" + tocfragment);

            var match = /local-doc-help\.eclipse\.org-([^.]*)(\.zh)?\//.exec(tocfragment);
            version = match[1];
            if (match[2]) {//å¦‚æœæ˜¯ä¸­è‹±æ–‡äº’è½¬
                tocfragmentT = tocfragment.replace(".zh/tocfragment.xml", "/tocfragment.xml");
            } else {
                tocfragmentT = tocfragment.replace("/tocfragment.xml", ".zh/tocfragment.xml");
            }
            //æ˜¯å¦å­˜åœ¨
            tocfragmentTFlag = await fetch(tocfragmentT).then(response => response.status == 200);
            if (tocfragmentTFlag) {
                tocfragmentTURL = new URL(window.location.href);
                tocfragmentTURL.searchParams.set("tocfragment", tocfragmentT);
                tocfragmentTURL.hash = "";//æ¸…ç©ºåŸå§‹hash
                tocfragmentTURL = tocfragmentTURL.toString();
            }

            //è·å– æ–‡æ¡£æ‰€åœ¨ä¸Šä¸‹æ–‡ è·¯å¾„
            context = tocfragment.substring(0, tocfragment.lastIndexOf("/"));
            console.log("context:" + context);
            hrefContext = new URL(context, window.location.href).href;//è·å–å¸®åŠ©æ–‡æ¡£çš„å…¨è·¯å¾„
            const response = await fetch(tocfragment).then(response => response.status == 200 ? response.text() : '');

            //è¯»å–xmlæ–‡ä»¶ä¸º dom æ–‡æ¡£ , ä¸HTMLçš„domæ–¹æ³•åŸºæœ¬ç±»ä¼¼
            const doc = parser.parseFromString(response, "application/xml");
            let navHTML = "";
            doc.querySelectorAll("node").forEach((node) => {
                let href = node.getAttribute("href");
                //href="../topic/../nav/3"  æ²¡æœ‰é¡µé¢
                // href="../topic/org.eclipse.acceleo.doc/pages/index.html?cp=5" æœ‰é¡µé¢
                if (href && href.indexOf(".htm") > 0) {//htmlå¯è¾¾
                    navHTML += `
                                <details 
                                    ontoggle="details_toggle(this)" 
                                    data-id="${node.getAttribute("id")}" 
                                    data-href="${node.getAttribute("href")}" 
                                    data-init="false">
                                           <summary><a target="_iframe" href="${context}/${href.replace('../topic/', '')}"> ${node.getAttribute("title")}</a></summary>
                                </details>`;
                } else {
                    navHTML += `
                                <details 
                                    ontoggle="details_toggle(this)" 
                                    data-id="${node.getAttribute("id")}" 
                                    data-href="${node.getAttribute("href")}" 
                                    data-init="false" >
                                    <summary > <a> ${node.getAttribute("title")} </a></summary> 
                                 </details>`;
                }
            });
            document.getElementById("tocNav").innerHTML = navHTML;

            findHash();//æŸ¥æ‰¾æ‰“å¼€çš„ç½‘é¡µ

            updateNavHrefs();//åŠ è½½å®Œæˆåæ›´æ–°åœ°å€
        }


        async function details_toggle(details) {

            if (details.dataset.init == "false") {
                details.dataset.init = "true";//åˆå§‹åŒ–

                let context2 = details.dataset.id;//å±€éƒ¨ä¸Šä¸‹æ–‡ ç¬¬äºŒéƒ¨åˆ†

                //å¤„ç†ç›¸å¯¹è·¯å¾„é—®é¢˜
                // "/org.eclipse.jst.ws.jaxws.doc.user/../org.eclipse.jst.ws.cxf.doc.user/tocreference.xml"
                if (context2.indexOf('/.') >= 0) {//å¦‚æœæ˜¯æœ‰ç›¸å¯¹è·¯å¾„ /. æˆ–è€… /..
                    context2 = (new URL(context2, windowsUrl)).pathname;
                }
                //context2 = context2.substring(0, context2.lastIndexOf("/"));
                context2 = context2.split("/")[1];//è·å¾—ç¬¬ä¸€éƒ¨åˆ† 0æ˜¯ç©ºæ ¼

                const response = await fetch(context + details.dataset.id).then(response => response.status == 200 ? response.text() : '');
                //console.log(response);

                if (!response) {//å†…å®¹ä¸æ­£ç¡®åˆ™è¾“å‡ºæ—¥å¿—
                    console.error(context + details.dataset.id + " response :" + response);
                    return;
                }

                const doc = parser.parseFromString(response, "application/xml");

                let detailsHTML = "";//è·å–æ‹¼æ¥å…ƒç´ 

                let toc = doc.children[0];//æ ¹èŠ‚ç‚¹ toc 


                /**
                    //xml ç‰¹æ®ŠèŠ‚ç‚¹ org.eclipse.linuxtools.docker.docs/toc-doc.xml ç‰¹æ®ŠåŒæ—¶æœ‰å…¶ä»–xml
                    //ä¾æ—§ä¸å®Œç¾ ä¼šæœ‰ ä¸‰é‡ åŸå› æ˜¯ org.eclipse.linuxtools.docker.docs/toc.xml æœ¬æ¥å°±æ˜¯äºŒå±‚ = =||
                    Docker Tooling User Guide
                     Docker Tooling User Guide
                         Docker Tooling User Guide 
                **/
                let link = toc.querySelector(':scope>link');
                if (link) {
                    detailsHTML += `
                        <details ontoggle="details_toggle(this)" 
                                 data-id="/${context2}/${link.getAttribute("toc")}" 
                                 data-href="${link.getAttribute("toc")}" 
                                 data-init="false" >
                                   <summary>${toc.getAttribute("label")}</summary>
                        </details>`;
                }

                toc.querySelectorAll(":scope>topic").forEach((topic) => {
                    detailsHTML += topic2html(topic, context, context2);
                });
                //ç¬¬ä¸€ä¸ªå…ƒç´  toc ä¹Ÿçœ‹åš topic çš„ä¸€ä¸ªèŠ‚ç‚¹ ç»“æ„ç±»ä¼¼ TODO é€»è¾‘ç†ä¸æ¸…
                //org.eclipse.linuxtools.docker.docs/toc-doc.xml åŒæ—¶æœ‰link å’Œ topic 
                //detailsHTML= topic2html(doc.querySelector('toc'), context, context2);

                //å…ƒç´ å‰ æ·»åŠ  æ–°å†…å®¹
                details.insertAdjacentHTML("beforeend", detailsHTML);

                console.log("init:" + details.dataset.id);
                updateNavHrefs();
            }

            //é¼ æ ‡è¿ç»­ç‚¹å‡»ä¸‰æ¬¡å±•å¼€å…¨éƒ¨èŠ‚ç‚¹
            clickCount++;//ä¸¤ç§’æ¸…é›¶
            setTimeout(function () {
                clickCount = 0;
            }, 2000);
            if (clickCount == 3) {
                detailsOpen(details);
            }
        }
        let clickCount = 0;//é¼ æ ‡ç‚¹å‡»æ•°ç›®



        //topic èŠ‚ç‚¹è½¬æ¢ä¸ºhtml æ–¹æ³•å¯ä»¥é€’å½’
        function topic2html(topic, context, context2) {
            let topicHTML = "";
            //<topic label="Tips and tricks" href="tips/platform_tips.html"> <link toc="topics_Tips.xml" /> </topic>
            //è·å–èŠ‚ç‚¹å­ç›®å½•
            let link = topic.querySelector(":scope>link");

            //<topic label="Concepts"><anchor id="concepts"/></topic>
            let anchor = topic.querySelector(":scope>anchor");

            //è·å–èŠ‚ç‚¹ä¸­è¶…é“¾æ¥
            let href = topic.getAttribute("href");
            //è·å–å­å…ƒç´ 
            let subTopics = topic.querySelectorAll(":scope>topic");

            //å¶å­ç»“ç‚¹ æ²¡æœ‰å­èŠ‚ç‚¹
            if (subTopics.length == 0 && !link && !anchor) {

                if (href.startsWith("http:") || href.startsWith("https:") || href.startsWith("//")) {
                    topicHTML += ` <a target="_iframe" href="${href}" title="å¤–é“¾å¯èƒ½éœ€è¦å³é”®çª—å£æ‰“å¼€"> ${topic.getAttribute("label")} </a>`;
                } else {
                    topicHTML += ` <a target="_iframe" href="${context}/${context2}/${href}"> ${topic.getAttribute("label")} </a>`;
                }

            } else {

                // xml å­ç›®å½•
                if (link) {//xml ç‰¹æ®ŠèŠ‚ç‚¹
                    topicHTML += ` <details ontoggle="details_toggle(this)" 
                                            data-id="/${context2}/${link.getAttribute("toc")}" 
                                            data-href="${link.getAttribute("href")}" 
                                            data-init="false" >`;
                } else if (anchor) {
                    topicHTML += ` <details ontoggle="details_toggle(this)" 
                                            data-id="/${context2}/toc${anchor.getAttribute("id")}.xml" 
                                            data-href="${anchor.getAttribute("href")}" 
                                            data-init="false" >`;
                } else {//æ™®é€šèŠ‚ç‚¹
                    topicHTML += `<details>`;
                }

                if (href) {//å¦‚æœæœ‰è¶…é“¾æ¥ 
                    topicHTML += ` <summary><a class='ad' target="_iframe" href="${context}/${context2}/${href}"> ${topic.getAttribute("label")} </a></summary>`;

                } else {
                    topicHTML += ` <summary><a> ${topic.getAttribute("label")} </a> </summary>`;
                }

                //é€’å½’
                subTopics.forEach((subTopic) => {
                    topicHTML += topic2html(subTopic, context, context2);
                });

                topicHTML += ` </details>`;
            }
            return topicHTML;
        }

        //åœ¨urlä¸­ä¿æŒæµè§ˆä½å­ ä¿è¯å¯åˆ†äº«
        function iframeLoad() {

            let _iframe = document.getElementById('_iframe');

            var iframeWindow = _iframe.contentWindow;
            if (iframeWindow && iframeWindow.document.location.href.indexOf(hrefContext) >= 0) {
                document.title = iframeWindow.document.title;
                var href = iframeWindow.document.location.href.replace(hrefContext, "");
                console.log("iframe reload:" + href);
                window.location.hash = href;
                iframeWindow.onhashchange = iframeLoad;//ç½‘é¡µè·³è½¬æ—¶å€™ä¹Ÿè§¦å‘

                // window.location.hash = encodeURIComponent(href);
            }
        }

        //æŸ¥æ‰¾æ‰“å¼€çš„æ–‡æ¡£åœ¨å·¦è¾¹å¯¼èˆªæ å“ªé‡Œå¤„
        let goHash = false;
        function findHash() {
            let hash = window.location.hash;
            if (hash) {

                let _iframe = document.getElementById('_iframe');

                //åˆ é™¤å¼€å¤´çš„ #/ æˆ–è€… /
                hash = hash.substring(1);

                console.log("_iframe reload:" + hrefContext + hash);
                _iframe.contentWindow.document.location.href = hrefContext + hash;

                // _iframe.src TODO è‡ªåŠ¨éå†å·¦è¾¹æ•°æ®
                hash = hash.startsWith('/') ? hash.substring(1) : hash;
                let words = hash.split('/');
                if (words.length > 0) {
                    console.log('words:' + words);
                    document.querySelectorAll("nav>details").forEach((detail) => {

                        if (detail.dataset.id && detail.dataset.id.indexOf(`/${words[0]}/`) >= 0) {
                            goHash = true;
                            detailsOpen(detail);
                        }
                    });


                }
            }
        }

        let detailsNum = 0, detailsOpenNum = 0;//æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦å®Œå…¨æ‰“å¼€
        function detailsOpen(detail) {

            detailsNum++;
            detail.ontoggle();
            detail.open = true;//æ‰“å¼€
            console.log("open details:" + detail.dataset.id);

            //åŠ è½½åŠ¨æ€æ•°æ®ä¼šæœ‰ä¸€å®šå»¶è¿Ÿ æ‰€ä»¥éœ€è¦ä½¿ç”¨å®šæ—¶å™¨
            var interval = setInterval(function () {
                let flag = false;//æ˜¯å¦æœ‰æœªæ‰“å¼€çš„èŠ‚ç‚¹
                detail.querySelectorAll("details").forEach((_detail) => {
                    console.log("look  details:" + _detail.dataset.id);
                    if (_detail.open == false) {
                        _detail.ontoggle && _detail.ontoggle();
                        _detail.open = true;
                        flag = true;
                        console.log("open details:" + _detail.dataset.id);
                    }
                });
                if (!flag) {
                    clearInterval(interval);
                    detailsOpenNum++;
                    checkDetailsOpened();
                }
                console.log("details Interval");
            }, 1000);
        }


        //æŸ¥çœ‹èŠ‚ç‚¹æ˜¯å¦å…¨éƒ¨åŠ è½½å®Œæˆ
        function checkDetailsOpened() {
            console.log("detailsNum " + detailsNum + " " + detailsOpenNum);
            if (detailsNum == detailsOpenNum) {
                console.log("èŠ‚ç‚¹å…¨éƒ¨åŠ è½½å®Œæˆ");
                updateNavHrefs();//åŠ è½½å®Œæˆåæ›´æ–°åœ°å€
            }
            if (goHash) {
                goHash = false;
                let hash = window.location.hash.substring(1);
                document.querySelectorAll("nav a").forEach((a) => {
                    if (a.href && a.href.indexOf(hash) > 0 && a.href.endsWith(hash)) {
                        a.scrollIntoView();//å¯¼èˆªæ è·³è½¬
                        a.style.background = "lightskyblue";//é¢œè‰²æ˜¾è‘—ä¸€ä¸‹
                    }
                });
            }

        }

        //
        //æ£€æŸ¥å…¨éƒ¨åœ°å€ æ˜¯å¦æœ‰404
        async function checkLink() {

            //ä¸ä¼šé˜»å¡ å›§
            //document.querySelectorAll("nav>details").forEach((detail) => {  detailsOpen(detail); }); 
            //console.log("Open all");


            let nodes = new Array();


            let details = document.querySelectorAll("nav details");
            for (i = 0; i < details.length; i++) {
                let detail = details[i];
                if (detail.dataset.id && detail.dataset.id.endsWith('xml')) {
                    if (! await fetch(context + detail.dataset.id).then(async (response) => response.status == 200)) {
                        nodes.push(detail.dataset.id);
                    }
                }
            }
            console.log("nodes length " + nodes.length);
            nodes = [...new Set(nodes)];
            console.log("nodes unique length " + nodes.length);
            let tocfragment = "";
            for (let i in nodes) {
                tocfragment += `<node id="${nodes[i]}" ></node>`;
            }
            tocfragment = `<?xml version="1.0" encoding="UTF-8"?>
                             <tree_data>
                             ${tocfragment}
                          </tree_data>`;

            console.log(tocfragment);
        }



        window.onload = load;
    </script>

</head>

<body>

    <nav id="navigation">

        <nav id="tocNav">

        </nav>
        <!--é»˜è®¤æœ€ä¸‹é¢çœ‹ä¸è§-->
        <span id="bookmark" style="position: fixed;top: 100vh">ğŸ”–</span>
        <br><br>

    </nav>
    <nav id="linkNav">


        <button title="è·³è½¬Eclipseå¸®åŠ©æ–‡æ¡£"
            onclick="window.open(`https://help.eclipse.org/${version}/index.jsp`); ">å®˜ç½‘</button>
        <button title="æ‰“å¼€ en/ä¸­æ–‡ ç‰ˆ"
            onclick="tocfragmentTFlag && window.open(`${tocfragmentTURL}${window.location.hash}`);">enâ‡„ä¸­æ–‡</button>


        <button onclick="displayToc()">éšè—/æ˜¾ç¤º</button>
        <button onclick="findHash()" title="2så†…è¿ç»­ç‚¹å‡»æ ¹èŠ‚ç‚¹å€’ä¸‰è§’ å®Œå…¨å±•å¼€">å±•å¼€èŠ‚ç‚¹</button>

        <button onclick="findHash()" title="Link with Contents/å³è¾¹é¡µé¢åŒæ­¥åˆ°å·¦è¾¹ç›®å½•"
            style="background: center/contain no-repeat url('images/e_auto_synch_toc.svg') ">
            &nbsp;&nbsp;&nbsp;&nbsp;</button>

        <button onclick="goPage(-1)">ä¸Šä¸€é¡µ</button>
        <button onclick="goPage(1)">ä¸‹ä¸€é¡µ</button>
    </nav>

    <iframe frameborder=0 id="_iframe" name="_iframe" src="" onload="iframeLoad()">

    </iframe>


</body>

</html>